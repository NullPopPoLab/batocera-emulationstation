<!DOCTYPE html>
<html lang=en>
<head>
	<meta charset="utf-8">
	<title>EmulationStation Web services</title>
	<link rel="shortcut icon" href="favicon.png">
	<link href="main.css" rel="stylesheet">
</head>
<body><div class=screen>
<header><img height="24" style="vertical-align: middle;" src="favicon.png"><span>EmulationStation Web services</span></header>
<main id=mainboard>
</main>
<footer><a target="_blank" href="https://batocera.org/">Batocera.linux</a>: <A target="_blank" href="https://github.com/NullPopPoLab/batocera.linux/wiki">NullPopPo custom</a></footer>
<script type="text/javascript"><!--

const ratingscore=['0','0.2','0.4','0.6','0.8','1']

var system_ctrl={}
var selected_system=null;

var main=document.getElementById('mainboard');

function httpGetJson(url,cbok=null,cbng=null){
	fetch(url)
		.then((res)=>{
			if(res.status>=200 && res.status<300){
				return res.json();
			}
			else{
				var err={code:res.status,msg:res.statusText}
				if(cbng)cbng(err);
				else console.log(JSON.stringify(err));
			}
		})
		.then((xml)=>{
			if(cbok)cbok(xml);
		})
		.catch((err)=>{
			if(cbng)cbng({error:err.toString()});
			else console.log(err.toString());
		});
}

function httpGetXML(url,cbok=null,cbng=null){
	fetch(url)
		.then((res)=>{
			if(res.status>=200 && res.status<300){
				return res;
			}
			else{
				var err={code:res.status,msg:res.statusText}
				if(cbng)cbng(err);
				else console.log(JSON.stringify(err));
			}
		})
		.then((res)=>{
			return res.text().then((xml)=>{
				var psr=new DOMParser();
				var data=psr.parseFromString(xml, "text/xml");
				if(cbok)cbok(data);
			});
		})
		.catch((err)=>{
			if(cbng)cbng({error:err.toString()});
			else console.log(err.toString());
		});
}

function httpPostJson(url,data,cbok=null,cbng=null){
	fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)})
		.then((res)=>{
			if(res.status>=200 && res.status<300){
				return res;
			}
			else{
				var err={code:res.status,msg:res.statusText}
				if(cbng)cbng(err);
				else console.log(JSON.stringify(err));
			}
		})
		.then((data)=>{
			if(cbok)cbok(data);
		})
		.catch((err)=>{
			if(cbng)cbng({error:err.toString()});
			else console.log(err.toString());
		});
}

function httpPostFile(url,data,cbok=null,cbng=null){
	fetch(url,{method:'POST',headers:{'Content-Type':'application/octet-stream'},body:data})
		.then((data)=>{
			if(cbok)cbok(data);
		})
		.catch((err)=>{
			if(cbng)cbng({error:err.toString()});
			else console.log(err.toString());
		});
}

function createElement(prm){

	if(!prm.tag){
		if(prm.target && prm.sub){
			for(var t of prm.sub){
				if(t===null){}
				else if(typeof t==='object')prm.target.append(t);
				else prm.target.innerHTML+=t;
			}
		}
		return null;
	}

	var el=document.createElement(prm.tag);
	if(prm.attr){
		for(var k in prm.attr){
			el.setAttribute(k,prm.attr[k]);
		}
	}
	if(prm.style){
		for(var k in prm.style){
			el.style[k]=prm.style[k];
		}
	}
	if(prm.sub){
		for(var t of prm.sub){
			if(t===null){}
			else if(typeof t==='object')el.append(t);
			else el.innerHTML+=t;
		}
	}
	if(prm.target)prm.target.append(el);
	return el;
}

const panel_progress=createElement({
	tag:'div',
	sub:['Now Loading...'],
});

const panel_mainboard=createElement({
	tag:'div',
	attr:{class:'mainboard'},
});

const panel_modalview=createElement({
	tag:'div',
	attr:{class:'modalview'},
});

const panel_syslist=createElement({
	target:panel_mainboard,
	tag:'div',
	attr:{class:'systemlist'},
});
const panel_sysview=createElement({
	target:panel_mainboard,
	tag:'div',
	attr:{class:'systemview'},
});
const panel_screenshots=createElement({
	tag:'div',
	attr:{class:'screenshots'},
});
const panel_workspace=createElement({
	tag:'div',
	attr:{class:'workspace'},
});
const panel_imageviewer=createElement({
	tag:'div',
	attr:{class:'imageviewer'},
});
const panel_gamelist=createElement({
	tag:'div',
	attr:{class:'gamelist'},
});
const panel_gameview=createElement({
	tag:'div',
	attr:{class:'gameview'},
});
const panel_genreeditor=createElement({
	tag:'div',
	attr:{class:'genreeditor'},
});
const panel_metaeditor=createElement({
	tag:'div',
	attr:{class:'metaeditor'},
});
const panel_mediaviewer=createElement({
	tag:'div',
	attr:{class:'mediaviewer'},
});
const panel_doclist=createElement({
	tag:'div',
	attr:{class:'doclist'},
});

function createSecondsTime(v){
	var h=Math.floor(v/3600);
	v-=h*3600;
	var m=Math.floor(v/60);
	v-=m*60;
	var s=Math.floor(v);
	var m2='0'+m;
	var s2='0'+s;
	return ''+h+':'+m2.substring(m2.length-2)+':'+s2.substring(s2.length-2);
}

function parseDate(v){
	if(!v)return '';
	if(v.length<8)return '';
	var y=parseInt(v.substring(0,4));
	if(isNaN(y))return '';
	var m=parseInt(v.substring(4,6));
	if(isNaN(m))return '';
	var d=parseInt(v.substring(6,8));
	if(isNaN(d))return '';
	var t=new Date(y,m-1,d);
	if(v.substring(8,9)!='T')return t;
	var h=parseInt(v.substring(9,11));
	if(isNaN(h))return t;
	var i=parseInt(v.substring(11,13));
	if(isNaN(i))return t;
	var s=parseInt(v.substring(13,15));
	if(isNaN(s))return t;
	t.setHours(h);
	t.setMinutes(i);
	t.setSeconds(s);
	return t;
}

function createDateTime(v){
	v=parseDate(v);
	if(!v)return '';
	var t=new Date(v);
	var y=''+t.getFullYear();
	var m='0'+(t.getMonth()+1);
	var d='0'+t.getDate();
	var h='0'+t.getHours();
	var i='0'+t.getMinutes();
	var s='0'+t.getSeconds();
	return y.substring(y.length-2,y.length)+'-'+
		m.substring(m.length-2,m.length)+'-'+
		d.substring(d.length-2,d.length)+' '+
		h.substring(h.length-2,h.length)+':'+
		i.substring(i.length-2,i.length)+':'+
		s.substring(s.length-2,s.length);
}

function createRatingControl(gt,onchange){

	var v=Math.floor(gt.rating*5+0.5);
	var s=[]
	var t={
		view:createElement({
			tag:'span',
			attr:{title:v},
		}),
		set:(v)=>{
			for(var i=0;i<5;++i){
				s[i].setAttribute('src',
					'/resources/star_'+((i<v)?'filled.svg':'unfilled.svg'));
			}
			t.view.setAttribute('title',v);
		},
	}

	for(var i=0;i<5;++i){
		var f=(i+1)<=v;
		s[i]=createElement({
			target:t.view,
			tag:'img',
			attr:{src:'/resources/star_'+(f?'filled.svg':'unfilled.svg')},
		});
		((i_)=>{
			s[i_].onclick=()=>{
				var i2=(i_==0 && v==1)?(i_-1):i_;
				v=i2+1;
				t.set(v);
				onchange(v);
			}
		})(i);
	}

	return t;
}

function createFavoriteButton(gt,onchange){

	var f=gt.favorite=='true';
	var t={
		view:createElement({tag:'button',attr:{class:f?'btn_favorite':'btn_normal'},sub:['Favorite']}),
		set:(f)=>{
			t.view.setAttribute('class',f?'btn_favorite':'btn_normal');
		},
	}
	t.view.onclick=()=>{
		f=!f;
		t.set(f);
		onchange(f);
	}
	return t;
}

function createHiddenButton(gt,onchange){

	var f=gt.hidden=='true';
	var t={
		view:createElement({tag:'button',attr:{class:f?'btn_hidden':'btn_normal'},sub:['Hidden']}),
		set:(f)=>{
			t.view.setAttribute('class',f?'btn_hidden':'btn_normal');
		},
	}
	t.view.onclick=()=>{
		f=!f;
		t.set(f);
		onchange(f);
	}
	return t;
}

function createRunnableButton(gt,onchange){

	var f=gt.runnable=='true';
	var t={
		view:createElement({tag:'button',attr:{class:f?'btn_runnable':'btn_normal'},sub:['Runnable']}),
		set:(f)=>{
			t.view.setAttribute('class',f?'btn_runnable':'btn_normal');
		},
	}
	t.view.onclick=()=>{
		f=!f;
		t.set(f);
		onchange(f);
	}
	return t;
}

function createKidGameButton(gt,onchange){

	var f=gt.kidgame=='true';
	var t={
		view:createElement({tag:'button',attr:{class:f?'btn_kidgame':'btn_normal'},sub:['Kid Game']}),
		set:(f)=>{
			t.view.setAttribute('class',f?'btn_kidgame':'btn_normal');
		},
	}
	t.view.onclick=()=>{
		f=!f;
		t.set(f);
		onchange(f);
	}
	return t;
}

function createMetaButton(st,gt,onsubmit){

	var btn=createElement({tag:'button',sub:['Meta']});
	btn.onclick=()=>{
		updateMetaEditor(st,gt,onsubmit);
	}
	return btn;
}

function createDetailButton(st,gt){

	var btn=createElement({tag:'button',sub:['Detail']});
	btn.onclick=()=>{
		updateGameView(st,gt);
	}
	return btn;
}

function createInstantErrorView(cols)
{
	var t={
		view:createElement({tag:'td',attr:{colspan:cols}}),
		clear:()=>{t.view.innerHTML='';},
		put:(err)=>{
			t.view.innerHTML='';
			t.view.append(createElement({
				tag:'span',
				attr:{class:'instanterror'},
				sub:[JSON.stringify(err)],
			}));
		},
	}

	return t;
}

var curlang='en';
function createLangSelect(list,cbchg){

	var sel=createElement({
		tag:'select',
	});
	var opt=[]
	for(var s in list){
		var p=createElement({
			target:sel,
			tag:'option',
			attr:{value:s},
			sub:[list[s]]
		});
		if(s==curlang)p.setAttribute('selected','selected');
		opt.push(p);
	}
	sel.onchange=()=>{
		curlang=opt[sel.selectedIndex].getAttribute('value');
		if(cbchg)cbchg(curlang);
	}
	
	return sel;
}

var genrelist=null;
function extractGenre(t,xml){
	var u={id:null,parent:null,sub:[],nom:{},btn:null,chk:null,lab:null}
	for(var sub of xml.children){
		if(sub.tagName=='id')u.id=sub.innerHTML;
		else if(sub.tagName=='parent'){
			u.parent=sub.innerHTML;
		}
		else if(sub.tagName.substring(0,4)=='nom_'){
			u.nom[sub.tagName.substring(4)]=sub.innerHTML;
		}
	}
	if(!u.id){
		console.log('missing id');
		return;
	}
	if(t.flat[u.id]){
		console.log('id dubbed; '+u.id);
		return;
	}
	u.btn={
		view:createElement({
			target:panel_syslist,
			tag:'span',
			attr:{class:'genre_off'},
			sub:[u.nom[curlang]??u.nom.en]
		}),
		_on:false,
		isOn:()=>u.btn._on,
		cbclick:null,
		setToggle:(f)=>{
			u.btn._on=f;
			u.btn.view.setAttribute('class',f?'genre_on':'genre_off');
		},
		setLang:(lang)=>{
			u.btn.view.innerHTML=u.nom[lang]??u.nom.en;
		},
		click:()=>{
			var f=!u.btn.isOn();
			u.btn.setToggle(f);
			return f;
		}
	}
	u.btn.view.onclick=()=>{
		var f=u.btn.click();
		if(u.btn.cbclick)u.btn.cbclick(f);
		if(f){
			if(u.parent)t.flat[u.parent].btn.setToggle(true);
		}
		else{
			for(var sub of u.sub)t.flat[sub.id].btn.setToggle(false);
		}
	}
	t.flat[u.id]=u;
}
function buildGenreView(view,u){

	var dt=createElement({
		target:view,
		tag:u.parent?'span':'p',
		attr:{class:'genregroup'},
		sub:[' ',u.btn.view]
	});
	if(u.sub.length<1)return;

	var dd=createElement({
		target:dt,
		tag:'div',
	});
	for(var sub of u.sub){
		buildGenreView(dd,sub);
	}
}
function buildGenreList(xml,onsubmit){
	var t={flat:{},tree:[]}
	t.view=createElement({
		tag:'div',
	});

	var langs={
		'de':'Deutsch',
		'en':'English',
		'es':'Español',
		'fr':'Français',
		'ja':'日本語',
		'pt':'Português',
	}
	createElement({
		target:t.view,
		tag:'div',
		attr:{class:'langslect'},
		sub:[createLangSelect(langs,(lang)=>{
			for(var id in t.flat){
				t.flat[id].btn.view.innerHTML=t.flat[id].nom[lang]??t.flat[id].nom.en;
		}})]
	});

	var dl=createElement({
		target:t.view,
		tag:'p',
		attr:{class:'genretree'}
	});

	xml=xml.children[0];
	if(!xml){
		console.log('empty xml');
		return t;
	}
	if(xml.tagName!='genres'){
		console.log('not genres');
		return t;
	}
	for(var g of xml.children){
		if(g.tagName!='genre'){
			console.log('not genre; '+g.tagName);
			continue;
		}
		extractGenre(t,g);
	}

	for(var id in t.flat){
		var u=t.flat[id];
		if(!u.parent)t.tree.push(u);
		else if(t.flat[u.parent]){
			t.flat[u.parent].sub.push(u);
		}
		else{
			console.log('missing parent; '+u.parent+'~'+u.id);
		}
	}

	for(var u of t.tree){
		buildGenreView(dl,u);
	}

	btn=createElement({
		target:dl,
		tag:'button',
		sub:['Submit'],
	});
	btn.onclick=()=>{
		if(onsubmit){
			var ids=[]
			var tree={}
			for(var id in t.flat){
				var u=t.flat[id];
				if(u.btn.isOn()){
					ids.push(id);
					if(u.parent){
						if(!tree[u.parent])tree[u.parent]=[]
						tree[u.parent].push(id);
					}
					else{
						if(!tree[id])tree[id]=[]
					}
				}
			}

			var nms=[]
			for(var id1 in tree){
				var u1=t.flat[id1]
				if(tree[id1].length<1){
					nms.push(u1.nom.en);
					continue;
				}
				var a=[]
				for(var id2 of tree[id1]){
					var u2=t.flat[id2]
					a.push(u2.nom.en);
				}
				nms.push(u1.nom.en+'('+a.join('; ')+')');
			}

			onsubmit(ids,nms.join(', '));
		}
	}

	return t;
}
function updateGenreList(gs){
	var t=genrelist;

	for(var id in t.flat){
		var u=t.flat[id];
		u.btn.setToggle(false);
	}
	for(var id of gs){
		var u=t.flat[id];
		if(!u)continue;
		u.btn.setToggle(true);
	}
}

function updateGenreEditor(gt,st,gs,onsubmit){
	gs=gs?gs.split(','):[];

	main.innerHTML='';
	panel_genreeditor.innerHTML='';

	createElement({
		target:panel_genreeditor,
		tag:'div',
		attr:{class:'systemcaption'},
		sub:[st.fullname]
	});
	createElement({
		target:panel_genreeditor,
		tag:'div',
		attr:{class:'gamecaption'},
		sub:[gt.name]
	});

	var btn=createElement({
		target:panel_genreeditor,
		tag:'button',
		sub:['Quit'],
	});
	btn.onclick=()=>{
		main.innerHTML='';
		main.append(panel_metaeditor);
	}

	createElement({
		target:panel_genreeditor,
		tag:'p',
		attr:{class:'editorcaption'},
		sub:['Genre Select'],
	});

	var view=createElement({
		target:panel_genreeditor,
		tag:'p',
	});

	main.append(panel_genreeditor);
	if(genrelist){
		updateGenreList(gs);
		view.innerHTML='';
		view.append(genrelist.view);
	}
	else{
		view.innerHTML='Now Loading...';
		httpGetXML('/resources/genres.xml',(xml)=>{
			genrelist=buildGenreList(xml,(ids,nms)=>{
				if(onsubmit)onsubmit(ids,nms);
				main.innerHTML='';
				main.append(panel_metaeditor);
			});
			updateGenreList(gs);
			view.innerHTML='';
			view.append(genrelist.view);
		},(err)=>{
			view.innerHTML=JSON.stringify(err.toString());
		});
	}
}

function updateMetaEditor(st,gt,onsubmit){

	main.innerHTML='';
	panel_metaeditor.innerHTML='';

	createElement({
		target:panel_metaeditor,
		tag:'div',
		attr:{class:'systemcaption'},
		sub:[st.fullname]
	});
	createElement({
		target:panel_metaeditor,
		tag:'div',
		attr:{class:'gamecaption'},
		sub:[gt.name]
	});

	var btn=createElement({
		target:panel_metaeditor,
		tag:'button',
		sub:['Quit'],
	});
	btn.onclick=()=>{
		main.innerHTML='';
		main.append(panel_mainboard);
	}

	createElement({
		target:panel_metaeditor,
		tag:'p',
		attr:{class:'editorcaption'},
		sub:['Meta Editor'],
	});

	const romdir='/userdata/roms/'+gt.systemName+'/';
	const romfile=gt.path.substring(romdir.length);
	var dst={}

	var tbl=createElement({
		target:panel_metaeditor,
		tag:'table',
		attr:{align:'center',border:'border'},
	});

	var meta={
		systemName:{capt:'Platform',type:'label'},
		romfile:{capt:'File',type:'val',func:()=>romfile},
		arcadesystemname:{capt:'Powered by',type:'lineinput'},
		name:{capt:'Captional Title',type:'lineinput'},
		title:{capt:'Formal Title',type:'lineinput'},
		sortname:{capt:'Sortable Title',type:'lineinput'},
		family:{capt:'Family',type:'lineinput'},
		desc:{capt:'Description',type:'textinput'},
		rating:{capt:'Rating',type:'rating'},
		flags:{capt:'Flags',type:'flags'},
		region:{capt:'Region',type:'lineinput'},
		lang:{capt:'Language',type:'lineinput'},
		releasedate:{capt:'Release Date',type:'date'},
		developer:{capt:'Developer',type:'lineinput'},
		publisher:{capt:'Publisher',type:'lineinput'},
		genres:{capt:'Genres',type:'genres'},
		players:{capt:'Players',type:'lineinput'},
		premise:{capt:'Premise',type:'textinput'},
		story:{capt:'Story',type:'textinput'},
		rule:{capt:'Rule',type:'textinput'},
		operation:{capt:'Operation',type:'textinput'},
		credit:{capt:'Credit',type:'textinput'},
		tips:{capt:'Tips',type:'textinput'},
		notes:{capt:'Notes',type:'textinput'},
		bugs:{capt:'Bugs',type:'textinput'},
	}

	for(var it in meta){
		var mt=meta[it]
		var sub=[createElement({tag:'th',sub:[mt.capt]})]
		switch(mt.type){
			case 'label':
			sub.push(createElement({tag:'td',sub:[gt[it]]}));
			break;

			case 'val':
			sub.push(createElement({tag:'td',sub:[mt.func()]}));
			break;

			case 'lineinput':
			var ui=createElement({tag:'input',attr:{type:'text',class:'metatextbox',name:it,value:gt[it]??''}});
			((it_,ui_)=>{ui_.onchange=()=>{dst[it_]=ui_.value;}})(it,ui);
			sub.push(ui);
			break;

			case 'textinput':
			var ui=createElement({tag:'textarea',attr:{name:it,wrap:'off',class:'metatextarea'},sub:[gt[it]??'']});
			((it_,ui_)=>{ui_.onchange=()=>{dst[it_]=ui_.value;}})(it,ui);
			sub.push(ui);
			break;

			case 'date':
			var d=parseDate(gt[it]);
			d=(!d)?'':(new Date(d).toISOString().substring(0,10));
			var ui=createElement({tag:'input',attr:{type:'text',class:'metatextbox',name:it,value:d}});
			((it_,ui_)=>{ui_.onchange=()=>{
				d=parseDate(ui_.value);
				dst[it_]=(!d)?'':(new Date(d).toISOString().substring(0,10));
			}})(it,ui);
			sub.push(ui);
			break;

			case 'rating':
			var c_rating=createRatingControl(gt,(score)=>{
				dst.rating=ratingscore[score];
			});
			sub.push(c_rating.view);
			break;

			case 'flags':
			var c_runnable=createRunnableButton(gt,(f)=>{
				dst.runnable=f?'true':'false';
			});
			sub.push(c_runnable.view);
			var c_kidgame=createKidGameButton(gt,(f)=>{
				dst.kidgame=f?'true':'false';
			});
			sub.push(c_kidgame.view);
			var c_favorite=createFavoriteButton(gt,(f)=>{
				dst.favorite=f?'true':'false';
			});
			sub.push(c_favorite.view);
			var c_hidden=createHiddenButton(gt,(f)=>{
				dst.hidden=f?'true':'false';
			});
			sub.push(c_hidden.view);
			break;

			case 'genres':
			var btn=createElement({tag:'button',sub:['Edit']});
			var gv=createElement({tag:'span',sub:[gt.genre]});
			((gs_,gv_)=>{btn.onclick=()=>{
				updateGenreEditor(gt,st,gs_,(ids,nms)=>{
					dst.genres=ids.join(',');
					dst.genre=nms;
					gv_.innerHTML=dst.genre;
				});
			}})(gt.genres,gv);
			sub.push(createElement({tag:'td',sub:[gv,' ',btn,]}));
			break;
		}
		createElement({target:tbl,tag:'tr',sub:sub});
	}

	btn=createElement({
		target:panel_metaeditor,
		tag:'button',
		sub:['Submit'],
	});
	btn.onclick=()=>{
		main.innerHTML='';
		if(onsubmit)onsubmit(dst);
		main.append(panel_mainboard);
	}

	main.append(panel_metaeditor);
}

function updateGameView(st,gt,cbchg,cberr){

	panel_sysview.innerHTML='';
	panel_gameview.innerHTML='';

	createElement({
		target:panel_gameview,
		tag:'div',
		attr:{class:'systemcaption'},
		sub:[st.fullname]
	});
	createElement({
		target:panel_gameview,
		tag:'div',
		attr:{class:'gamecaption'},
		sub:[gt.name]
	});

	if(gt.jukeboxAvailable=='true'){
		var btn=createElement({
			target:panel_gameview,
			tag:'button',
			sub:['JukeBox'],
		});
		btn.onclick=()=>{
			var url='/systems/'+st.name+'/games/'+gt.id;
			updateImageViewer(url+'/scraper/jukebox',(data)=>{
				var a={base:url+'/scraper/jukebox/',dir:[],file:[]}
				for(var b of data.dirs){
					// from ./ 
					a.dir.push(b.substring(2));
				}
				for(var b of data.files){
					// from ./ 
					a.file.push(b.substring(2));
				}
				return a;
			},()=>{
				main.innerHTML='';
				main.append(panel_mainboard);
			});
		}
	}

	if(gt.slideshowAvailable=='true'){
		var btn=createElement({
			target:panel_gameview,
			tag:'button',
			sub:['SlideShow'],
		});
		btn.onclick=()=>{
			var url='/systems/'+st.name+'/games/'+gt.id;
			updateImageViewer(url+'/scraper/slideshow',(data)=>{
				var a={base:url+'/scraper/slideshow/',dir:[],file:[]}
				for(var b of data.dirs){
					// from ./ 
					a.dir.push(b.substring(2));
				}
				for(var b of data.files){
					// from ./ 
					a.file.push(b.substring(2));
				}
				return a;
			},()=>{
				main.innerHTML='';
				main.append(panel_mainboard);
			});
		}
	}

	panel_gameview.append(createMetaButton(st,gt,(dst)=>{
		for(var k in dst)gt[k]=dst[k];
		if(cbchg)cbchg();
		var url='/systems/'+st.name+'/games';
		var post2=url+'/'+gt.id;
		httpPostJson(post2,dst,null,(err)=>{
			if(cberr)cberr(err);
		});
	}));

	var btn=createElement({
		target:panel_gameview,
		tag:'button',
		sub:['Quit'],
	});
	btn.onclick=()=>{
		panel_sysview.innerHTML='';
		panel_sysview.append(panel_gamelist);
	}

	var meta={
		'manual':'Manual',
		'magazine':'Magazine',
	}
	for(var it in meta){
		var frm=createElement({
			target:panel_gameview,
			tag:'p',
		});

		var path=gt[it];
		createElement({
			target:frm,
			tag:path?'a':'span',
			attr:path?{target:'_blank',href:gt[it],class:'mediacaption'}:{class:'mediacaption'},
			sub:[meta[it]]
		});
		createElement({target:frm,tag:'span',sub:[' ']});
//		var file=createElement({
//			target:frm,
//			tag:'input',
//			type:'file',
//			accept:'.pdf,.cbz',
//		});
//		var btn=createElement({
//			target:frm,
//			tag:'button',
//			sub:[path?'Replace':'Register']
//		});
//		((file_,btn_)=>{
//			btn_.onclick=()=>{
//				var url='/systems/'+st.name+'/games/'+gt.id+'/media/'+it;
//				httpPostFile(url,file_.);
//			}
//		})(file,btn);
	}

	if(gt.docsAvailable=='true'){
		createElement({target:panel_gameview,tag:'hr'});

		var list=createElement({target:panel_gameview,tag:'div',sub:['Now Loading...']});

		var pref='/systems/'+gt.systemName+'/games/'+gt.id+'/scraper/';
		httpGetJson(pref+'docs.json',(data)=>{
			list.innerHTML='';
			for(var it in data){
				var path=data[it];
				var frm=createElement({
					target:list,
					tag:'p',
				});

				createElement({
					target:frm,
					tag:'a',
					attr:{target:'_blank',href:(path.indexOf(':')<0)?(pref+encodeURI(path)):path},
					sub:[it]
				});
			}
		},(err)=>{
			list.innerHTML='';
			list.append(createElement({
				tag:'span',
				attr:{class:'instanterror'},
				sub:[JSON.stringify(err)],
			}));
		});
	}

	meta={
		'video':'Video',
		'image':'Image',
		'thumbnail':'Thumbnail',
		'titleshot':'Title Shot',
		'ingame':'Ingame Shot',
		'bezel':'Bezel',
		'marquee':'Marquee',
		'boxart':'Box Front',
		'boxback':'Box Back',
		'cartridge':'Cartridge',
		'pcb':'PCB',
		'wheel':'Wheel',
		'flyer':'Flyer',
		'fanart':'Fan Art',
		'mix':'Mix',
		'map':'Map',
	}
	for(var it in meta){
		var frm=createElement({
			target:panel_gameview,
			tag:'div',
			attr:{class:'imgframe'},
		});

		var path=gt[it];

		createElement({
			target:frm,
			tag:'p',
			sub:[
				createElement({tag:'span',attr:{class:'mediacaption'},sub:[meta[it]+' ']}),
//				createElement({tag:'button',sub:[path?'Replace':'Register']})
			],
		});
		if(!path)continue;
		createElement({
			target:frm,
			tag:'p',
			sub:[
				(it=='video')?
					createElement({tag:'video',attr:{controls:'controls'},sub:[
						createElement({tag:'source',attr:{src:gt[it]}})
					]}):
				createElement({tag:'img',attr:{src:gt[it]}})
			],
		});
	}

	var btn=createElement({
		target:panel_gameview,
		tag:'button',
		sub:['Quit'],
	});
	btn.onclick=()=>{
		main.innerHTML='';
		main.append(panel_mainboard);
	}

	panel_sysview.append(panel_gameview);
}

function exportTSV(st,data){
	var cols=['ID','Platform','Path','Powered','Caption','Title','Sortable','Family','Rating','Runa','Favo','Hide','Kids','Reg','Lang','Date','Developer','Publisher','Players']
	var t=[cols.join("\t")]

	for(var gt of data){
		if(!gt.id)continue;
		if(!gt.systemName)continue;
		if(!gt.path)continue;
		var d=[]
		d.push(gt.id);
		d.push(gt.systemName);
		// from /userdata/roms/SystemName/ 
		d.push(gt.path.substring(16+gt.systemName.length));
		d.push(gt.arcadesystemname??'');
		d.push(gt.name??'');
		d.push(gt.title??'');
		d.push(gt.sortname??'');
		d.push(gt.family??'');
		var rating=parseFloat(gt.rating);
		if(isNaN(rating))rating='';
		else rating=Math.floor(rating*5+0.5);
		if(!rating)rating='';
		d.push(rating);
		d.push((gt.runnable=='true')?1:0);
		d.push((gt.favorite=='true')?1:0);
		d.push((gt.hidden=='true')?1:0);
		d.push((gt.kidgame=='true')?1:0);
		d.push(gt.region??'');
		d.push(gt.lang??'');
		var date=parseDate(gt.releasedate);
		d.push(isNaN(d)?'':(new Date(date).toISOString().substring(0,10)));
		t.push(d.join("\t"));
		d.push(gt.developer??'');
		d.push(gt.publisher??'');
		d.push(gt.players??'');
	}

	return t.join("\n")+"\n";
}

function importTSV(st,data,tsv,cbok,cbng){

	var lines=tsv.split("\n");
	if(lines.length<2){
		console.log('no enough lines');
		return;
	}
	var hd={}
	var ha=lines.shift().trimEnd().split("\t");
	for(var i in ha)hd[ha[i]]=i;

	if(!('ID' in hd) && !('Platform' in hd) && !('Path' in hd)){
		console.log('no enough columns');
		return;
	}
	var dd={}
	for(var i in data)dd[data[i].id]=i;
	for(var s of lines){
		if(!s)continue;
		var sa=s.trimEnd().split("\t");
		var id=sa[hd.ID];
console.log(id+'; '+sa[hd.Path]);
		if(!(id in dd)){
			console.log(id+': not found');
			continue;
		}
		var gt=data[dd[id]];
		if(sa[hd.Platform]!=gt.systemName){
			console.log(id+': System misimatch; '+sa[hd.System]+'/'+gt.systemName);
			continue;
		}
		var dpath=gt.path.substring(16+gt.systemName.length);
		if(sa[hd.Path]!=dpath){
			console.log(id+': System misimatch; '+sa[hd.Path]+'/'+dpath);
			continue;
		}
		var dst={}
		// 単純文字列系 
		var meta={
			'Powered':'arcadesystemname',
			'Caption':'name',
			'Title':'title',
			'Sortable':'sortname',
			'Family':'family',
			'Reg':'region',
			'Lang':'lang',
			'Developer':'developer',
			'Publisher':'publisher',
			'Players':'players',
		}
		for(var m in meta){
			if(!(m in hd))continue;
			var sv=sa[hd[m]]??'';
			var dv=gt[meta[m]]??'';
			if(sv!=dv)dst[meta[m]]=sv;
		}
		// フラグ系 
		meta={
			'Runa':'runnable',
			'Favo':'favorite',
			'Hide':'hidden',
			'Kids':'kidgame',
		}
		for(var m in meta){
			if(!(m in hd))continue;
			var sv=sa[hd[m]]??'';
			if(sv!='')sv=(parseInt(sv))?'true':'false';
			var dv=gt[meta[m]]??'';
			if(sv!=dv)dst[meta[m]]=sv;
		}
		// 特殊 
		if('Rating' in hd){
			if(!(m in hd))continue;
			var sv=parseInt(sa[hd.Rating])??0;
			if(isNaN(sv))sv=0;
			else sv=ratingscore[sv];
			var dv=gt.rating??0;
			if(sv!=dv)dst.rating=sv;
		}
		if('Date' in hd){
			if(!(m in hd))continue;
			var sv=parseDate(sa[hd.Date]??'');
			var dv=parseDate(gt.releasedate??'');
			if(sv!=dv)dst.releasedate=sv?(new Date(sv).toISOString()):'';
		}
		for(var k in dst)gt[k]=dst[k];
		var url='/systems/'+gt.systemName+'/games/'+gt.id;
		httpPostJson(url,dst,(data)=>{
			if(cbok)cbok();
		},(err)=>{
			console.log(err.toString()+'; '+url+': '+JSON.stringify(dst));
			if(cbng)cbng(err);
		});
	}
}

function updateGameList(ctrl){

	panel_sysview.innerHTML='';
	panel_gamelist.innerHTML='';

	var st=ctrl.src;
	createElement({
		target:panel_gamelist,
		tag:'div',
		sub:[createElement({
			tag:'img',
			attr:{src:st.logo,alt:st.fullname,class:'systemicon'},
		})],
	});

	var games=createElement({
		target:panel_gamelist,
		tag:'div',
		sub:['Now Loading...'],
	});

	var url='/systems/'+st.name+'/games';
	httpGetJson(url,(data)=>{

		if(data.length<1){
			games.innerHTML='no entries';
			return;
		}

		data.sort((a,b)=>{return a.name<b.name?-1:1});

		games.innerHTML='';

		var saver=createElement({
			target:games,
			tag:'a',
		});

		var btn=createElement({
			target:games,
			tag:'button',
			sub:['Export'],
		});
		btn.onclick=()=>{
			var blob=new Blob([exportTSV(st,data)],{type:'text/tab-separated-values'});
			saver.href=URL.createObjectURL(blob);
			saver.download=st.name+'.tsv';
			saver.click();
		}
		var srcfile=null;
		btn=createElement({
			target:games,
			tag:'button',
			sub:['Import'],
		});
		btn.onclick=()=>{
			if(!srcfile)return;
			var fd=new FileReader();
			fd.readAsText(srcfile);
			fd.addEventListener('load',()=>{
				importTSV(st,data,fd.result);
			},()=>{
				updateGameList(ctrl)
			},
			()=>{
				updateGameList(ctrl)
			});
		}
		var chooser=createElement({
			target:games,
			tag:'input',
			attr:{type:'file',accept:'.tsv'},
		});
		chooser.addEventListener('change',(e)=>{
			var fs=e.target.files;
			if(fs<1)return;
			srcfile=e.target.files[0];
		});

		var tbl=createElement({
			target:games,
			tag:'table',
			attr:{border:'border',class:'gamelist'},
		});

		var tr=createElement({
			target:tbl,
			tag:'tr',
			sub:[
				createElement({tag:'th',sub:['Name']}),
				createElement({tag:'th',sub:['Count']}),
				createElement({tag:'th',sub:['Total Time']}),
				createElement({tag:'th',sub:['Last Played']}),
				createElement({tag:'th',sub:['Rating']}),
				createElement({tag:'th',sub:['Etc']}),
			],
		});

		for(var gt of data){
			((gt_)=>{
				var post2=url+'/'+gt_.id;
				var errview=createInstantErrorView(6);
				var c_rating=createRatingControl(gt_,(score)=>{
					gt_.rating=ratingscore[score];
					errview.clear();
					httpPostJson(post2,{rating:gt_.rating},null,(err)=>{
						errview.put(err);
					});
				});
				var c_favorite=createFavoriteButton(gt_,(f)=>{
					gt_.favorite=f?'true':'false';
					errview.clear();
					httpPostJson(post2,{favorite:gt_.favorite},null,(err)=>{
						errview.put(err);
					});
				});
				var c_hidden=createHiddenButton(gt_,(f)=>{
					gt_.hidden=f?'true':'false';
					errview.clear();
					httpPostJson(post2,{hidden:gt_.hidden},null,(err)=>{
						errview.put(err);
					});
				});
				tr=createElement({
					target:tbl,
					tag:'tr',
					sub:[
						createElement({tag:'td',attr:{class:'tblcapt'},sub:[gt_.name]}),
						createElement({tag:'td',attr:{class:'tblnum'},sub:[gt_.playcount]}),
						createElement({tag:'td',attr:{class:'tblnum'},sub:[createSecondsTime(gt_.gametime)]}),
						createElement({tag:'td',attr:{class:'tblnum'},sub:[createDateTime(gt_.lastplayed)]}),
						createElement({tag:'td',attr:{class:'tblstar'},sub:[c_rating.view]}),
						createElement({tag:'td',attr:{class:'tbltool'},sub:[
							c_favorite.view,
							c_hidden.view,
							createDetailButton(st,gt_,()=>{
								errview.clear();
								c_rating.set(Math.floor(dst.rating*5+0.5));
								c_favorite.set(dst.favorite=='true');
								c_hidden.set(dst.hidden=='true');
							},(err)=>{
								errview.put(err);
							}),
						]}),
					],
				});
				tr=createElement({target:tbl,tag:'tr',sub:[errview.view]});
			})(gt);
		}
	},(err)=>{
		games.innerHTML=JSON.stringify(err);
	});

	panel_sysview.append(panel_gamelist);
}

function getMediaType(path){
	var p=path.lastIndexOf('.');
	var ext=(p<0)?'':path.substring(p+1);
	switch(ext){
		case 'avi':
		case 'mpg':
		case 'mkv':
		case 'mp4':
		case 'webm':
		return 'video';

		case 'mp3':
		case 'ogg':
		case 'flac':
		case 'wav':
		return 'audio';

		case 'gif':
		case 'jfif':
		case 'jpg':
		case 'jpeg':
		case 'png':
		case 'bmp':
		return 'image';

		case 'cbz':
		case 'doc':
		case 'docx':
		case 'htm':
		case 'html':
		case 'md':
		case 'nfo':
		case 'pdf':
		case 'ppt':
		case 'pptx':
		case 'txt':
		case 'xls':
		case 'xlsx':
		case 'xml':
		return 'text';
	}
	return '';
}

function showImage(title,canvas,capt,url){

	title.innerHTML=capt;
	canvas.innerHTML='';

	switch(getMediaType(url)){
		case 'video':
		createElement({
			target:canvas,
			tag:'video',
			attr:{controls:'controls'},
			sub:[createElement({tag:'source',attr:{src:url}})
		]});
		break;

		case 'audio':
		createElement({
			target:canvas,
			tag:'audio',
			attr:{controls:'controls'},
			sub:[createElement({tag:'source',attr:{src:url}})
		]});
		break;

		case 'image':
		createElement({
			target:canvas,
			tag:'img',
			attr:{src:url}
		});
		break;

		default:
		createElement({
			target:canvas,
			tag:'div',
			sub:['(Unknown Type)']
		});
	}
}

function updateImageViewer(url,onload,onquit){

	panel_imageviewer.innerHTML='';
	panel_screenshots.innerHTML='Now Loading...';

	httpGetJson(url,(data)=>{
		var attr=onload(data);
		var max=attr.file.length;
		if(max<1){
			panel_screenshots.innerHTML='(empty)';
			return;
		}
		var idx=0;

		main.innerHTML='';
		var head=createElement({
			target:panel_imageviewer,
			tag:'div',
			attr:{class:'imagehead'},
		});
		var tool=createElement({
			target:head,
			tag:'div',
			attr:{class:'imagetool'},
		});
		var ctrl=createElement({
			target:tool,
			tag:'div',
			attr:{class:'imagectrl'},
		});
		var btns=createElement({
			target:tool,
			tag:'div',
			attr:{class:'imagebtns'},
		});
		var btnl=createElement({
			target:btns,
			tag:'button',
			attr:{class:'imagebtn'},
			sub:['←']
		});
		var btnr=createElement({
			target:btns,
			tag:'button',
			attr:{class:'imagebtn'},
			sub:['→']
		});
		var btnq=createElement({
			target:btns,
			tag:'button',
			attr:{class:'imagebtn'},
			sub:['×']
		});
		var canvas=createElement({
			target:panel_imageviewer,
			tag:'div',
			attr:{class:'imagecanvas'},
		});

		var show=(idx)=>{
			var name=attr.file[idx];
			var url=attr.base+name;
			showImage(ctrl,canvas,name,url);
		}

		show(idx);
		btnl.onclick=()=>{
			idx=(idx+max-1)%max;
			show(idx);
		}
		btnr.onclick=()=>{
			idx=(idx+1)%max;
			show(idx);
		}
		btnq.onclick=()=>{
			onquit();
			panel_screenshots.innerHTML='';
		}
		main.append(panel_imageviewer);
	},(err)=>{
		panel_screenshots.innerHTML=JSON.stringify(err);
	});

	panel_sysview.append(panel_screenshots);
}

function updateMainBoard(data){

	panel_syslist.innerHTML='';

	var st={Collection:[],Gallery:[]}
	for(var src of data){
		switch(src.manufacturer){
			case 'Collections': st.Collection.push(src); break;
			case 'Gallery': st.Gallery.push(src); break;
			default:
			if(!st[src.hardwareType])st[src.hardwareType]=[]
			st[src.hardwareType].push(src);
		}
	}

	for(var k in st){
		if(st[k].length<1)continue;
		createElement({target:panel_syslist,tag:'div',attr:{class:'cardgroup'},sub:k});
		for(var src of st[k]){
			var n=src.name;
			var t=system_ctrl[n]={
				src:src,
			}
			t.btn=createElement({target:panel_syslist,tag:'div',attr:{class:'card_others'},sub:src.fullname});
			((n_,t_)=>{
				t_.btn.onclick=()=>{
					if(n_==selected_system)return;
					if(selected_system)system_ctrl[selected_system].btn.setAttribute('class','card_others');
					system_ctrl[n_].btn.setAttribute('class','card_selected');
					selected_system=n_;
					if(n_=='imageviewer')updateImageViewer('/systems/imageviewer/games',(data)=>{
						var a={base:'/screenshots/',dir:[],file:[]}
						for(var b of data){
							// from /userdata/screenshots/ 
							a.file.push(b.path.substring(22));
						}
						return a;
					},()=>{
						if(selected_system)system_ctrl[selected_system].btn.setAttribute('class','card_others');
						selected_system='';
						main.innerHTML='';
						main.append(panel_mainboard);
					});
					else updateGameList(t_);
				}
			})(n,t);
		}
	}
}

main.append(panel_progress);
httpGetJson('/systems',(data)=>{
	updateMainBoard(data);
	main.innerHTML='';
	main.append(panel_mainboard);
},(err)=>{
	main.innerHTML=JSON.stringify(err);
});

//--></script>
</div></body></html>
